<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>DBpia ë…¼ë¬¸ ì¶”ì²œ</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; margin: 0; }
    .container {
      max-width: 800px;
      margin: 40px auto;
      background: white;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; color: #333; }
    button {
      padding: 8px 16px;
      background: #007BFF; color: white;
      border: none; border-radius: 6px;
      cursor: pointer; font-size: 14px;
    }
    button:hover { background: #0056b3; }
    .form-row { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; align-items: center; }
    .form-row label {
      display: flex; align-items: center; gap: 8px;
      font-weight: 600; flex: 1;
    }
    .form-row input, .form-row select {
      flex: 1; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px;
    }
    #top-bar { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px; }
    #greeting { font-weight: 600; align-self: center; }
    #logout { display: none; }

    /* ë¶ë§ˆí¬ ë²„íŠ¼ */
    .bookmark-btn { margin-left: 10px; background: #ffb300; color: #333; }
    .bookmark-btn.bookmarked { background: #ffd54f !important; color: #007BFF !important; }

    /* ëª¨ë‹¬ */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
    .modal.active { display: flex; }
    .modal-content { background: #fff; padding: 20px 30px; border-radius: 8px; width: 360px; position: relative; }
    .modal-close { position: absolute; top: 10px; right: 12px; background: none; border: none; font-size: 18px; cursor: pointer; }
    .message { color: green; font-size: 0.9em; text-align: center; margin-top: 8px; }

    /* ì¶”ì²œ */
    .subject-group { margin-top: 10px; padding-left: 10px; }
    .subject-group label { display: inline-block; margin-right: 15px; font-weight: normal; }
    #result { margin-top: 40px; }
    .paper {
      background: #f1f4f8; padding: 16px 20px; border-radius: 10px;
      margin-bottom: 15px; border-left: 5px solid #007BFF; position: relative;
    }
    .paper strong { font-size: 18px; color: #222; }
    .paper em { color: #666; display: block; margin-top: 4px; font-style: normal; }
    .paper a { display: inline-block; margin-top: 8px; color: #007BFF; text-decoration: none; }
    .paper a:hover { text-decoration: underline; }

    /* ë‚´ ì¦ê²¨ì°¾ê¸° ëª¨ë‹¬ */
    #modal-bookmark .modal-content { width: 500px; max-height: 70vh; overflow-y: auto; }
    .bm-list { margin: 0; padding: 0; list-style: none; }
    .bm-list li {
      margin-bottom: 15px; background: #f9fbe7; padding: 13px 18px;
      border-radius: 8px; border-left: 5px solid #ffd54f; position: relative;
    }
    .bm-remove {
      position: absolute; right: 16px; top: 18px;
      color: #e74c3c; background: none; border: none; font-size: 16px; cursor: pointer;
    }
  </style>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  <div class="container">
    <h1>ğŸ“š DBpia ì¸ê¸° ë…¼ë¬¸ ì¶”ì²œ ì‹œìŠ¤í…œ</h1>

    <!-- ìƒë‹¨ë°” -->
    <div id="top-bar">
      <button id="open-signup">íšŒì›ê°€ì…</button>
      <button id="open-login">ë¡œê·¸ì¸</button>
      <span id="greeting"></span>
      <button id="open-bookmark" style="display:none;">ë‚´ ì¦ê²¨ì°¾ê¸°</button>
      <button id="open-mypage" style="display:none;">ë§ˆì´í˜ì´ì§€</button>
      <button id="logout">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- ì¶”ì²œ í¼ -->
    <form id="recommend-form">
      <div class="form-row">
        <label>ì—°ë„ ì„ íƒ
          <select name="pyear">
            <option value="">(ì„ íƒ ì•ˆ í•¨)</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
          </select>
        </label>
        <label>ì›” ì„ íƒ
          <select name="pmonth">
            <option value="">(ì„ íƒ ì•ˆ í•¨)</option>
            <option value="01">1ì›”</option>
            <option value="02">2ì›”</option>
            <option value="03">3ì›”</option>
            <option value="04">4ì›”</option>
            <option value="05">5ì›”</option>
            <option value="06">6ì›”</option>
            <option value="07">7ì›”</option>
            <option value="08">8ì›”</option>
            <option value="09">9ì›”</option>
            <option value="10">10ì›”</option>
            <option value="11">11ì›”</option>
            <option value="12">12ì›”</option>
          </select>
        </label>
      </div>
      <div class="form-row">
  	<label>ì •ë ¬ ê¸°ì¤€:
    	  <select name="sort_by">
      	    <option value="popularity">ì¸ê¸°ìˆœ</option>
      	    <option value="title">ì œëª©ìˆœ</option>
    	  </select>
  	</label>
  	<label>ì •ë ¬ ìˆœì„œ:
    	  <select name="order">
      	    <option value="desc">ë‚´ë¦¼ì°¨ìˆœ</option>
      	    <option value="asc">ì˜¤ë¦„ì°¨ìˆœ</option>
    	  </select>
  	</label>
      </div>
      <div class="form-row">
  	<label>ê²€ìƒ‰:
    	  <input type="text" name="query" placeholder="ë…¼ë¬¸ ì œëª© ë˜ëŠ” ì €ì ì´ë¦„">
	</label>
      </div>
      <div class="form-row">
        <label>ì£¼ì œ ë¶„ë¥˜:</label>
        <div class="subject-group">
          <label><input type="radio" name="category" value="">ì „ì²´</label>
          <label><input type="radio" name="category" value="1">ì¸ë¬¸í•™</label>
          <label><input type="radio" name="category" value="2">ì‚¬íšŒê³¼í•™</label>
          <label><input type="radio" name="category" value="3">ìì—°ê³¼í•™</label>
          <label><input type="radio" name="category" value="4">ê³µí•™</label>
          <label><input type="radio" name="category" value="5">ì˜ì•½í•™</label>
          <label><input type="radio" name="category" value="6">ë†ìˆ˜í•´ì–‘</label>
          <label><input type="radio" name="category" value="7">ì˜ˆìˆ ì²´ìœ¡</label>
          <label><input type="radio" name="category" value="8">ë³µí•©í•™</label>
          <label><input type="radio" name="category" value="9">êµì–‘</label>
        </div>
      </div>
      <button type="submit">ë…¼ë¬¸ ì¶”ì²œë°›ê¸°</button>
    </form>
    <div id="result"></div>
  </div>

  <!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
  <div id="modal-signup" class="modal">
    <div class="modal-content">
      <button class="modal-close" data-close="modal-signup">&times;</button>
      <h2>íšŒì›ê°€ì…</h2>
      <form id="signup-form">
        <div class="form-row"><label>ì•„ì´ë””<input type="text" name="username" required minlength="3"></label></div>
        <div class="form-row"><label>ë‹‰ë„¤ì„<input type="text" name="nickname" required minlength="2"></label></div>
        <div class="form-row"><label>ë¹„ë°€ë²ˆí˜¸<input type="password" name="password" required minlength="6"></label></div>
        <button type="submit">ê°€ì…í•˜ê¸°</button>
      </form>
      <div id="signup-msg" class="message"></div>
    </div>
  </div>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="modal-login" class="modal">
    <div class="modal-content">
      <button class="modal-close" data-close="modal-login">&times;</button>
      <h2>ë¡œê·¸ì¸</h2>
      <form id="login-form">
        <div class="form-row"><label>ì•„ì´ë””<input type="text" name="username" required></label></div>
        <div class="form-row"><label>ë¹„ë°€ë²ˆí˜¸<input type="password" name="password" required></label></div>
        <button type="submit">ë¡œê·¸ì¸</button>
      </form>
      <div id="login-msg" class="message"></div>
    </div>
  </div>

<!-- ë§ˆì´í˜ì´ì§€ ëª¨ë‹¬ (ìˆ˜ì • ì™„ë£Œ) -->
<div id="modal-mypage" class="modal">
  <div class="modal-content">
    <button class="modal-close" data-close="modal-mypage">&times;</button>
    <h2>ë§ˆì´í˜ì´ì§€</h2>

    <!-- íƒ­ ë²„íŠ¼ -->
    <div class="tab-buttons" style="display: flex; gap: 10px; margin-bottom: 10px;">
      <button class="tab-btn" data-tab="tab-nickname">ë‹‰ë„¤ì„ ë³€ê²½</button>
      <button class="tab-btn" data-tab="tab-password">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
    </div>
    <hr style="margin: 10px 0;">

    <!-- ë‹‰ë„¤ì„ ë³€ê²½ íƒ­ -->
    <div id="tab-nickname" class="mypage-tab">
      <form id="nickname-form">
        <div class="form-row">
          <label>ìƒˆ ë‹‰ë„¤ì„<input type="text" name="nickname" required minlength="2"></label>
        </div>
        <button type="submit">ë³€ê²½í•˜ê¸°</button>
      </form>
      <div id="nickname-msg" class="message"></div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ íƒ­ -->
    <div id="tab-password" class="mypage-tab" style="display: none;">
      <form id="mypage-form">
        <div class="form-row"><label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸<input type="password" name="current_password" required minlength="6"></label></div>
        <div class="form-row"><label>ìƒˆ ë¹„ë°€ë²ˆí˜¸<input type="password" name="new_password" required minlength="6"></label></div>
        <button type="submit">ë³€ê²½í•˜ê¸°</button>
      </form>
      <div id="mypage-msg" class="message"></div>
    </div>
  </div>
</div>

  <!-- ë‚´ ì¦ê²¨ì°¾ê¸° ëª¨ë‹¬ -->
  <div id="modal-bookmark" class="modal">
    <div class="modal-content">
      <button class="modal-close" data-close="modal-bookmark">&times;</button>
      <h2>ë‚´ ì¦ê²¨ì°¾ê¸° ë…¼ë¬¸</h2>
      <ul class="bm-list" id="bm-list"></ul>
      <div id="bookmark-msg" class="message"></div>
    </div>
  </div>

  <script type="module">
    const API_BASE = location.hostname === "localhost" || location.hostname === "127.0.0.1"
    ? "http://127.0.0.1:8000"
    : "https://recosearch.co.kr";

    // ê³µí†µ ì¸ì¦ í—¤ë” ë°˜í™˜
    function authHeaders() {
      const token = localStorage.getItem('token');
      return token ? { 'Authorization': `Bearer ${token}` } : {};
    }

    // GET ìš”ì²­
    async function apiGet(path, params = {}) {
      const url = new URL(API_BASE + path);
      Object.entries(params).forEach(([k, v]) => {
        if (v !== undefined && v !== '') url.searchParams.append(k, v);
      });
      const res = await fetch(url, { headers: authHeaders() });
      if (!res.ok) throw res;
      return res.json();
    }

    // POST/DELETE ìš”ì²­
    async function apiSend(path, { method = 'POST', body } = {}) {
      const headers = { ...authHeaders() };
      if (body !== undefined) headers['Content-Type'] = 'application/json';
      const res = await fetch(API_BASE + path, {
        method,
        headers,
        body: body !== undefined ? JSON.stringify(body) : undefined
      });
      if (!res.ok) throw res;
      return res.status === 204 ? null : res.json();
    }

    // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    const openModal = id => document.getElementById(id).classList.add('active');
    const closeModal = id => document.getElementById(id).classList.remove('active');
    document.querySelectorAll('.modal-close').forEach(b => b.onclick = () => closeModal(b.dataset.close));
    document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => e.target === m && closeModal(m.id)));
    document.getElementById('open-signup').onclick = () => openModal('modal-signup');
    document.getElementById('open-login').onclick  = () => openModal('modal-login');
    document.getElementById('open-mypage').onclick = () => openModal('modal-mypage');
    document.getElementById('open-bookmark').onclick = () => { loadBookmarks(); openModal('modal-bookmark'); };

    // ì¸ì‚¬ë§Â·ë‹‰ë„¤ì„ í‘œì‹œ
    async function showGreeting() {
      const token = localStorage.getItem('token');
      if (!token) return;
      let userInfo;
      try {
        userInfo = await apiGet('/auth/me');
      } catch {
        userInfo = { username: localStorage.getItem('username') };
      }
      document.getElementById('open-signup').style.display   = 'none';
      document.getElementById('open-login').style.display    = 'none';
      document.getElementById('logout').style.display        = 'inline-block';
      document.getElementById('open-bookmark').style.display = 'inline-block';
      document.getElementById('open-mypage').style.display   = 'inline-block';
      document.getElementById('greeting').textContent        = `${userInfo.nickname || userInfo.username}ë‹˜, ë°˜ê°‘ìŠµë‹ˆë‹¤!`;
    }
    document.getElementById('logout').onclick = () => {
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      window.location.reload();
    };
    window.addEventListener('DOMContentLoaded', showGreeting);

    // ë©”ì‹œì§€ í—¬í¼
    const showMessage = (id, txt, color = 'green') => {
      const el = document.getElementById(id);
      el.textContent = txt;
      el.style.color   = color;
    };
	  
    // íƒ­ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mypage-tab').forEach(tab => tab.style.display = 'none');
        document.getElementById(btn.dataset.tab).style.display = 'block';
      });
    });

    // ë‹‰ë„¤ì„ ë³€ê²½
    document.getElementById('nickname-form').addEventListener('submit', async e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target));
      try {
        await apiSend('/mypage/nickname', { method: 'PATCH', body: data });
        showMessage('nickname-msg', 'âœ… ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        setTimeout(() => {
          showGreeting();
          closeModal('modal-mypage');
        }, 1000);
      } catch {
        showMessage('nickname-msg', 'âŒ ë‹‰ë„¤ì„ ë³€ê²½ ì‹¤íŒ¨', 'red');
      }
    });

    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
    document.getElementById('mypage-form').addEventListener('submit', async e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target));
      try {
        await apiSend('/mypage/password', { method: 'PATCH', body: data });
        showMessage('mypage-msg', 'âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        setTimeout(() => closeModal('modal-mypage'), 1000);
      } catch (res) {
        const err = await res.json();
        const msg = err.detail || 'âŒ ë³€ê²½ ì‹¤íŒ¨';
        if (msg.includes("ê°™")) {
          showMessage('mypage-msg', 'âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ê°™ìŠµë‹ˆë‹¤.', 'red');
        } else if (msg.includes("ì¼ì¹˜")) {
          showMessage('mypage-msg', 'âŒ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.', 'red');
        } else {
          showMessage('mypage-msg', 'âŒ ë³€ê²½ ì‹¤íŒ¨', 'red');
        }
      }
    });
	  
    // íšŒì›ê°€ì…
    document.getElementById('signup-form').addEventListener('submit', async e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target));
      try {
        await apiSend('/auth/signup', { body: data });
        showMessage('signup-msg', 'ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
      } catch (res) {
        const err = await res.json();
        showMessage('signup-msg', err.detail || 'ê°€ì… ì‹¤íŒ¨', 'red');
      }
    });

    // ë¡œê·¸ì¸
    document.getElementById('login-form').addEventListener('submit', async e => {
      e.preventDefault();
      const form = new URLSearchParams(new FormData(e.target));
      try {
        const { access_token } = await fetch(API_BASE + '/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: form
        }).then(r => r.json());
        localStorage.setItem('token', access_token);
        localStorage.setItem('username', form.get('username'));
        closeModal('modal-login');
        showGreeting();
      } catch {
        showMessage('login-msg', 'ë¡œê·¸ì¸ ì‹¤íŒ¨', 'red');
      }
    });

    // ë‚´ ë¶ë§ˆí¬ ë§µ ë¡œë”©
    async function loadBookmarksSet() {
      try {
        const data = await apiGet('/bookmarks/');
        return Object.fromEntries(data.map(bm => [bm.paper_id, bm.id]));
      } catch {
        return {};
      }
    }

    // ì¶”ì²œ ìš”ì²­ & ë Œë”ë§
    document.getElementById('recommend-form').addEventListener('submit', async e => {
      e.preventDefault();
      const params = Object.fromEntries(new FormData(e.target));
      try {
        const { recommendations } = await apiGet('/recommend', params);
        renderRecommendations(recommendations);
      } catch (res) {
        if (res.status === 401) alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        else alert('ì¶”ì²œ ë…¼ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      }
    });

    function renderRecommendations(recs) {
  loadBookmarksSet().then(bmMap => {
    const html = recs.map(item => {
      const api = item.link_api || "";
      const m = api.match(/id=(NODE\d+)/);
      const nodeIdParam = m ? m[1] : null;
      const nodeId = nodeIdParam || `NODE${item.paper_id}`;
      const detailUrl = `https://www.dbpia.co.kr/journal/articleDetail?nodeId=${nodeId}`;
      const pid = item.paper_id;
      const bookmarked = bmMap[pid] !== undefined;

      return `
        <div class="paper" data-paper-id="${pid}">
          <strong>${item.title}</strong>
          <em>ì €ì: ${item.authors.map(a => a.name).join(', ')}</em>
          <p>ê°„í–‰ë¬¼: ${item.publication?.name || 'N/A'}</p>
          <a href="${detailUrl}" target="_blank" rel="noopener noreferrer"
             style="display:inline-block; margin:4px 0;
                    font-size:0.9em; color:#007BFF; text-decoration:none;">
            ìƒì„¸ ë³´ê¸°
          </a>
          <button class="bookmark-btn${bookmarked ? ' bookmarked' : ''}"
        data-paper-id="${pid}"
        data-paper-title="${item.title.replace(/"/g, '&quot;')}"
        data-paper-authors="${item.authors.map(a => a.name).join(', ')}"
        data-paper-year="${item.publication?.year || ''}"
        data-bookmark-id="${bookmarked ? bmMap[pid] : ''}">
  ${bookmarked ? 'ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€'}
</button>

        </div>
      `;
    }).join('');
    document.getElementById('result').innerHTML = html;
  });
}



    // ë¶ë§ˆí¬ ì¶”ê°€/ì‚­ì œ í•¸ë“¤ëŸ¬
    document.getElementById('result').addEventListener('click', async e => {
  if (!e.target.classList.contains('bookmark-btn')) return;

  const btn = e.target;
  const paper_id = btn.dataset.paperId;
  const title = btn.dataset.paperTitle;
  const authors = btn.dataset.paperAuthors;
  const published_year = btn.dataset.paperYear;
  const bookmarkId = btn.dataset.bookmarkId;
  const token = localStorage.getItem('token');
  if (!token) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');

  try {
    if (btn.classList.contains('bookmarked')) {
      await apiSend(`/bookmarks/${bookmarkId}`, { method: 'DELETE' });
      btn.classList.remove('bookmarked');
      btn.textContent = 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€';
      btn.dataset.bookmarkId = '';
    } else {
      const { id } = await apiSend('/bookmarks/', {
        body: { paper_id, title, authors, published_year }
      });
      btn.classList.add('bookmarked');
      btn.textContent = 'ì¦ê²¨ì°¾ê¸° í•´ì œ';
      btn.dataset.bookmarkId = id;
    }
  } catch (error) {
    const msg = error.status === 422 ? 'âš ï¸ ì„œë²„ë¡œ ë³´ë‚¸ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' : 'âŒ ì˜¤ë¥˜ ë°œìƒ';
    alert(msg);
    console.error(await error.text?.());
  }
});


    // ë‚´ ì¦ê²¨ì°¾ê¸° ëª¨ë‹¬ ë¡œë”©
    async function loadBookmarks() {
      const token = localStorage.getItem('token');
      if (!token) return;
      const ul = document.getElementById('bm-list');
      ul.innerHTML = '<li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>';
      try {
        // ìŠ¬ë˜ì‹œ(/) ê¼­ ë¶™ì´ê¸°
        const list = await apiGet('/bookmarks/');
        ul.innerHTML = list.length
          ? list.map(bm => `
              <li>
                <strong>${bm.title}</strong><br>      <!-- title ì‚¬ìš© -->
                <small>ID: ${bm.id}</small><br>
                <a href="${bm.link}"
                  target="_blank"
                  style="display:inline-block; margin:4px 0; font-size:0.9em; color:#007BFF; text-decoration:none;">
                  ìƒì„¸ ë³´ê¸°
                </a>
                <button class="bm-remove" data-bmid="${bm.id}">âœ–</button>
              </li>
            `).join('')
          : '<li>ì¦ê²¨ì°¾ê¸°í•œ ë…¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
      } catch {
        ul.innerHTML = '<li>ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜</li>';
      }
    }

    // ì¦ê²¨ì°¾ê¸° ëª¨ë‹¬ ë‚´ í•´ì œ
    document.getElementById('bm-list').addEventListener('click', async e => {
      if (!e.target.classList.contains('bm-remove')) return;
      const bmid = e.target.dataset.bmid;
      try {
        await apiSend(`/bookmarks/${bmid}`, { method: 'DELETE' });
        e.target.closest('li').remove();
      } catch {
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

  </script>
</body>
</html>
